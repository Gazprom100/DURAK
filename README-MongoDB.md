# Безопасное подключение к MongoDB

В этом документе описаны правила безопасной работы с MongoDB для проекта DURAK.

## Установка зависимостей

Для работы с MongoDB необходимо установить следующие пакеты:

```bash
pip install pymongo python-dotenv
```

## Настройка переменных окружения

1. Создайте файл `.env` в корне проекта, используя `.env.example` как шаблон:

```bash
cp .env.example .env
```

2. Отредактируйте файл `.env` и замените `your_password_here` на реальный пароль:

```
MONGODB_PASSWORD=your_password_here
```

**ВАЖНО:** Файл `.env` добавлен в `.gitignore` и НИКОГДА не должен попадать в систему контроля версий.

## Структура кода

Проект использует следующие файлы для работы с MongoDB:

- `config.py` - содержит конфигурационные параметры, загружаемые из `.env`
- `db.py` - содержит функции для подключения к базе данных и работы с ней
- `mongodb_example.py` - пример использования функций для работы с MongoDB

## Использование в коде

### Простое использование

```python
from db import get_database, close_connection

try:
    # Получаем объект базы данных
    db = get_database()
    
    # Работаем с коллекциями
    users_collection = db["users"]
    user = users_collection.find_one({"email": "example@example.com"})
    
    # Важно закрыть соединение после работы
    close_connection(db.client)
except Exception as e:
    print(f"Ошибка при работе с базой данных: {e}")
```

### Использование с декоратором

```python
from db import with_mongodb_connection

@with_mongodb_connection
def get_user_by_email(email, db=None):
    return db.users.find_one({"email": email})

# Вызов функции (соединение открывается и закрывается автоматически)
user = get_user_by_email("example@example.com")
```

## Правила безопасности

1. **Никогда не храните учетные данные в коде** - используйте переменные окружения или файл `.env`
2. **Всегда закрывайте соединения** - используйте `close_connection()` или декоратор `with_mongodb_connection`
3. **Используйте SSL-соединение** - убедитесь, что `SSL_ENABLED=True` в настройках
4. **Ограничивайте доступ по IP** - настройте в Atlas MongoDB доступ только с определенных IP-адресов
5. **Используйте правило минимальных привилегий** - создавайте пользователей с минимально необходимыми правами
6. **Регулярно меняйте пароли** - устанавливайте напоминания о смене паролей
7. **Проверяйте входные данные** - всегда валидируйте данные перед отправкой запросов к базе
8. **Логируйте ошибки** - настройте правильное логирование для отладки

## Отладка и мониторинг

1. Для отладки установите `LOG_LEVEL=DEBUG` в файле `.env`
2. Для мониторинга используйте MongoDB Atlas Dashboard
3. Настройте оповещения о необычной активности в MongoDB Atlas

## Создание пользователей с ограниченными правами

Для создания пользователя с ограниченными правами в MongoDB Atlas выполните следующие шаги:

1. Войдите в MongoDB Atlas
2. Выберите свой кластер
3. Перейдите в "Database Access"
4. Нажмите "ADD NEW DATABASE USER"
5. Выберите "Password" как метод аутентификации
6. Укажите имя пользователя и пароль
7. В разделе "Database User Privileges" выберите "Custom"
8. Добавьте роли с минимально необходимыми правами для конкретной базы данных
9. Нажмите "Add User"

Пример ролей для пользователя с ограниченными правами:
- `readWrite` только для базы данных приложения
- `read` для логов и аналитики 